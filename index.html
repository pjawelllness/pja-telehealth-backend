<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PJA Wellness - Telehealth Consultations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }

        .provider-portal-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .provider-portal-btn:hover {
            background: white;
            color: #667eea;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .badge-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .content {
            padding: 40px;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .step.active .step-circle {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .step.completed .step-circle {
            background: #4CAF50;
            color: white;
        }

        .step-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .step.active .step-label {
            color: #667eea;
            font-weight: 600;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .service-card {
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .service-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102,126,234,0.2);
        }

        .service-card.selected {
            border-color: #667eea;
            background: #f5f7ff;
        }

        .service-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .service-price {
            font-size: 2em;
            color: #667eea;
            font-weight: bold;
            margin: 15px 0;
        }

        .service-duration {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .service-description {
            color: #666;
            line-height: 1.6;
        }

        .hsa-badge {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .consent-box {
            background: #f5f7ff;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .consent-box h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .consent-box p {
            line-height: 1.6;
            color: #666;
            margin-bottom: 15px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
            margin-right: 10px;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .time-slot {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .time-slot:hover {
            border-color: #667eea;
            background: #f5f7ff;
        }

        .time-slot.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee;
            border: 2px solid #f44336;
            color: #c00;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .provider-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .provider-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #666;
        }

        .booking-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .booking-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .booking-info-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
        }

        .booking-info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .booking-info-value {
            font-weight: 600;
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f5f7ff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 10px;
        }

        .payment-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .payment-warning h3 {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="provider-portal-btn" onclick="showProviderPortal()">Provider Portal</button>
            <h1>PJA Wellness</h1>
            <p>Virtual Holistic Health Consultations</p>
            <div class="badge-container">
                <div class="badge">HIPAA Compliant</div>
                <div class="badge">Board Certified</div>
                <div class="badge">HSA/FSA Accepted</div>
            </div>
        </div>

        <div class="content">
            <div class="error-message" id="errorMessage"></div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Service</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Personal</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Health</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Consent</div>
                </div>
                <div class="step" id="step5">
                    <div class="step-circle">5</div>
                    <div class="step-label">Schedule</div>
                </div>
                <div class="step" id="step6">
                    <div class="step-circle">6</div>
                    <div class="step-label">Payment</div>
                </div>
            </div>

            <!-- Step 1: Service Selection -->
            <div class="form-section active" id="section1">
                <h2>Select Your Service</h2>
                <div class="loading active" id="servicesLoading">
                    <div class="spinner"></div>
                    <p>Loading available services...</p>
                </div>
                <div id="servicesList"></div>
                <div class="button-group">
                    <div></div>
                    <button class="btn btn-primary" onclick="nextStep(2)">Next: Personal Information</button>
                </div>
            </div>

            <!-- Step 2: Personal Information -->
            <div class="form-section" id="section2">
                <h2>Personal Information</h2>
                <div class="form-group">
                    <label for="firstName">First Name *</label>
                    <input type="text" id="firstName" required>
                </div>
                <div class="form-group">
                    <label for="lastName">Last Name *</label>
                    <input type="text" id="lastName" required>
                </div>
                <div class="form-group">
                    <label for="email">Email Address *</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone Number *</label>
                    <input type="tel" id="phone" required>
                </div>
                <div class="form-group">
                    <label for="dob">Date of Birth *</label>
                    <input type="date" id="dob" required>
                </div>
                <div class="form-group">
                    <label for="emergencyName">Emergency Contact Name</label>
                    <input type="text" id="emergencyName">
                </div>
                <div class="form-group">
                    <label for="emergencyPhone">Emergency Contact Phone</label>
                    <input type="tel" id="emergencyPhone">
                </div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep(1)">Back</button>
                    <button class="btn btn-primary" onclick="nextStep(3)">Next: Health Information</button>
                </div>
            </div>

            <!-- Step 3: Health Information -->
            <div class="form-section" id="section3">
                <h2>Health Information</h2>
                <div class="form-group">
                    <label for="chiefComplaint">Chief Complaint / Reason for Visit *</label>
                    <textarea id="chiefComplaint" required placeholder="Please describe your primary concern or reason for this consultation"></textarea>
                </div>
                <div class="form-group">
                    <label for="symptomDuration">How long have you experienced these symptoms? *</label>
                    <input type="text" id="symptomDuration" required placeholder="e.g., 2 weeks, 3 months">
                </div>
                <div class="form-group">
                    <label>Current Symptoms (check all that apply)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item"><input type="checkbox" value="Pain" id="symptom1"><label for="symptom1">Pain</label></div>
                        <div class="checkbox-item"><input type="checkbox" value="Fatigue" id="symptom2"><label for="symptom2">Fatigue</label></div>
                        <div class="checkbox-item"><input type="checkbox" value="Stress" id="symptom3"><label for="symptom3">Stress</label></div>
                        <div class="checkbox-item"><input type="checkbox" value="Sleep Issues" id="symptom4"><label for="symptom4">Sleep Issues</label></div>
                        <div class="checkbox-item"><input type="checkbox" value="Digestive Issues" id="symptom5"><label for="symptom5">Digestive Issues</label></div>
                        <div class="checkbox-item"><input type="checkbox" value="Other" id="symptom6"><label for="symptom6">Other</label></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="medications">Current Medications</label>
                    <textarea id="medications" placeholder="List all medications you're currently taking"></textarea>
                </div>
                <div class="form-group">
                    <label for="allergies">Allergies</label>
                    <textarea id="allergies" placeholder="List any allergies (medications, foods, etc.)"></textarea>
                </div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep(2)">Back</button>
                    <button class="btn btn-primary" onclick="nextStep(4)">Next: Consent Forms</button>
                </div>
            </div>

            <!-- Step 4: Consent Forms -->
            <div class="form-section" id="section4">
                <h2>Consent & Agreement</h2>
                
                <div class="consent-box">
                    <h3>HIPAA Privacy Notice</h3>
                    <p>I acknowledge that I have received and reviewed the HIPAA Privacy Notice, which describes how my health information may be used and disclosed by PJA Wellness Management LLC.</p>
                    <div class="checkbox-item">
                        <input type="checkbox" id="consentHipaa" required>
                        <label for="consentHipaa">I acknowledge the HIPAA Privacy Notice *</label>
                    </div>
                </div>

                <div class="consent-box">
                    <h3>Telehealth Informed Consent</h3>
                    <p>I consent to participate in telehealth services provided by Patrick Smith, BCHHP. I understand that telehealth involves the use of electronic communications to enable healthcare providers at different locations to share individual patient medical information for the purpose of improving patient care. The laws that protect the confidentiality of medical information also apply to telehealth.</p>
                    <div class="checkbox-item">
                        <input type="checkbox" id="consentTelehealth" required>
                        <label for="consentTelehealth">I agree to the Telehealth Informed Consent *</label>
                    </div>
                </div>

                <div class="consent-box">
                    <h3>Session Recording (Optional)</h3>
                    <p>For quality assurance and your medical record, sessions may be recorded. This is optional and you may decline.</p>
                    <div class="checkbox-item">
                        <input type="checkbox" id="consentRecording">
                        <label for="consentRecording">I consent to session recording (optional)</label>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep(3)">Back</button>
                    <button class="btn btn-primary" onclick="nextStep(5)">Next: Schedule Appointment</button>
                </div>
            </div>

            <!-- Step 5: Schedule Appointment -->
            <div class="form-section" id="section5">
                <h2>Select Date & Time</h2>
                <div class="form-group">
                    <label for="appointmentDate">Select Date *</label>
                    <input type="date" id="appointmentDate" onchange="loadAvailability()">
                </div>
                <div class="loading" id="availabilityLoading">
                    <div class="spinner"></div>
                    <p>Loading available times...</p>
                </div>
                <div id="availabilityGrid"></div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep(4)">Back</button>
                    <button class="btn btn-primary" onclick="nextStep(6)">Next: Payment</button>
                </div>
            </div>

            <!-- Step 6: Payment -->
            <div class="form-section" id="section6">
                <h2>Complete Payment</h2>
                
                <div class="payment-warning">
                    <h3>⚠️ Important: Payment Required Before Booking</h3>
                    <p>To secure your appointment, you must complete payment first. After payment is confirmed, your appointment will be created and you'll receive confirmation via email/SMS with your Doxy.me video consultation link.</p>
                </div>

                <div style="background: #f5f7ff; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">Appointment Summary</h3>
                    <div id="appointmentSummary"></div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep(5)">Back</button>
                    <button class="btn btn-primary" id="proceedToPaymentBtn" onclick="proceedToPayment()">
                        Proceed to Secure Payment →
                    </button>
                </div>
                <div class="loading" id="paymentLoading">
                    <div class="spinner"></div>
                    <p>Redirecting to secure payment...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Provider Portal Modal -->
    <div class="provider-modal" id="providerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Provider Portal</h2>
                <button class="close-btn" onclick="closeProviderPortal()">&times;</button>
            </div>

            <div id="providerLogin">
                <div class="form-group">
                    <label for="providerPassword">Password</label>
                    <input type="password" id="providerPassword" onkeypress="if(event.key==='Enter') loginProvider()">
                </div>
                <div class="error-message" id="loginError"></div>
                <button class="btn btn-primary" onclick="loginProvider()">Login</button>
            </div>

            <div id="providerDashboard" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="todayCount">0</div>
                        <div class="stat-label">Today's Appointments</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="weekCount">0</div>
                        <div class="stat-label">This Week</div>
                    </div>
                </div>
                <h3 style="margin-bottom: 20px;">Upcoming Appointments</h3>
                <div id="bookingsList"></div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let selectedService = null;
        let selectedTime = null;
        let availableServices = [];

        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', () => {
            loadServices();
            setMinDate();
            
            // Check if returning from payment
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('payment') === 'complete') {
                completeBookingAfterPayment();
            }
        });

        function setMinDate() {
            const today = new Date();
            today.setDate(today.getDate() + 1); // Start from tomorrow
            const minDate = today.toISOString().split('T')[0];
            document.getElementById('appointmentDate').setAttribute('min', minDate);
        }

        // LOAD SERVICES
        async function loadServices() {
            try {
                const response = await fetch('/api/services');
                const data = await response.json();
                availableServices = data.services || [];
                
                const servicesList = document.getElementById('servicesList');
                if (availableServices.length === 0) {
                    servicesList.innerHTML = '<p style="text-align:center;color:#666;">No services available at this time.</p>';
                } else {
                    servicesList.innerHTML = availableServices.map(service => `
                        <div class="service-card" data-service-id="${service.id}" onclick="selectService('${service.id}')">
                            <div class="service-title">${service.name}</div>
                            <div class="service-price">$${service.price}</div>
                            <div class="service-duration">⏱ ${service.duration} minutes</div>
                            <div class="service-description">${service.description || 'Professional holistic health consultation via secure video'}</div>
                            <div class="hsa-badge">HSA/FSA Accepted</div>
                        </div>
                    `).join('');
                }
                
                document.getElementById('servicesLoading').classList.remove('active');
            } catch (error) {
                console.error('Error loading services:', error);
                showError('Failed to load services. Please refresh the page.');
            }
        }

        function selectService(serviceId) {
            // Remove previous selection
            document.querySelectorAll('.service-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            document.querySelector(`[data-service-id="${serviceId}"]`).classList.add('selected');
            
            selectedService = availableServices.find(s => s.id === serviceId);
        }

        // LOAD AVAILABILITY
        async function loadAvailability() {
            if (!selectedService) {
                showError('Please select a service first');
                return;
            }

            const dateInput = document.getElementById('appointmentDate');
            const selectedDate = dateInput.value;
            
            if (!selectedDate) {
                return;
            }

            const loadingDiv = document.getElementById('availabilityLoading');
            const gridDiv = document.getElementById('availabilityGrid');
            
            loadingDiv.classList.add('active');
            gridDiv.innerHTML = '';

            try {
                const response = await fetch('/api/availability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        serviceVariationId: selectedService.variationId,
                        date: selectedDate
                    })
                });

                const data = await response.json();
                const availabilities = data.availabilities || [];

                loadingDiv.classList.remove('active');

                if (availabilities.length === 0) {
                    gridDiv.innerHTML = '<p style="text-align:center;color:#666;">No available time slots for this date. Please select another date.</p>';
                } else {
                    gridDiv.innerHTML = '<div class="calendar-grid">' + 
                        availabilities.map(slot => `
                            <div class="time-slot" data-start-at="${slot.startAt}" onclick="selectTime('${slot.startAt}', '${slot.time}')">
                                ${slot.time}
                            </div>
                        `).join('') + 
                    '</div>';
                }
            } catch (error) {
                loadingDiv.classList.remove('active');
                showError('Failed to load availability. Please try again.');
            }
        }

        function selectTime(startAt, time) {
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            document.querySelector(`[data-start-at="${startAt}"]`).classList.add('selected');
            
            selectedTime = { startAt, time };
        }

        // PAYMENT FLOW
        function proceedToPayment() {
            if (!validateStep(6)) {
                return;
            }

            const paymentBtn = document.getElementById('proceedToPaymentBtn');
            const loadingDiv = document.getElementById('paymentLoading');
            
            paymentBtn.disabled = true;
            loadingDiv.classList.add('active');

            // Collect all form data
            const bookingData = {
                personal: {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    dob: document.getElementById('dob').value,
                    emergencyName: document.getElementById('emergencyName').value,
                    emergencyPhone: document.getElementById('emergencyPhone').value
                },
                health: {
                    chiefComplaint: document.getElementById('chiefComplaint').value,
                    symptomDuration: document.getElementById('symptomDuration').value,
                    symptoms: Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                        .filter(cb => cb.id.startsWith('symptom'))
                        .map(cb => cb.value),
                    medications: document.getElementById('medications').value,
                    allergies: document.getElementById('allergies').value
                },
                consents: {
                    hipaa: document.getElementById('consentHipaa').checked,
                    telehealth: document.getElementById('consentTelehealth').checked,
                    recording: document.getElementById('consentRecording').checked
                },
                service: selectedService,
                selectedTime: selectedTime
            };

            // Store booking data in localStorage (will be used after payment)
            localStorage.setItem('pendingBooking', JSON.stringify(bookingData));

            // Payment links for each service
            const paymentLinks = {
                'LDJS2FCCQ3TVI5YKU6ZTGJZI': 'https://square.link/u/seXJR3vc',  // Comprehensive Wellness
                'IEJHSQ6VBA77WQEOD65ZDCES': 'https://square.link/u/IYT3hsZj',  // Follow-up
                'PRH777UHCBNYQJXZ7BNKZWEA': 'https://square.link/u/0Gfis1tW'   // Acute Care
            };

            const paymentLink = paymentLinks[selectedService.id];
            
            if (paymentLink) {
                // Redirect to payment with return URL
                window.location.href = paymentLink + '?redirect_url=' + encodeURIComponent(window.location.origin + '?payment=complete');
            } else {
                showError('Payment link not configured. Please contact support.');
                paymentBtn.disabled = false;
                loadingDiv.classList.remove('active');
            }
        }

        // COMPLETE BOOKING AFTER PAYMENT
        async function completeBookingAfterPayment() {
            const pendingBooking = localStorage.getItem('pendingBooking');
            
            if (!pendingBooking) {
                showError('No pending booking found. Please start over.');
                return;
            }

            const bookingData = JSON.parse(pendingBooking);
            
            // Show loading
            document.body.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column;">
                    <div class="spinner"></div>
                    <h2 style="margin-top: 20px;">Creating your appointment...</h2>
                    <p>Please wait while we confirm your booking.</p>
                </div>
            `;

            try {
                const response = await fetch('/api/booking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });

                const result = await response.json();

                if (result.success) {
                    // Clear pending booking
                    localStorage.removeItem('pendingBooking');
                    
                    // Show success message
                    document.body.innerHTML = `
                        <div class="container" style="margin-top: 50px;">
                            <div class="header">
                                <h1>✓ Appointment Confirmed!</h1>
                                <p>Your telehealth consultation has been scheduled</p>
                            </div>
                            <div class="content">
                                <div style="background: #e8f5e9; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                                    <h2 style="color: #2e7d32; margin-bottom: 20px;">Booking Details</h2>
                                    <p><strong>Service:</strong> ${result.confirmation.service}</p>
                                    <p><strong>Date:</strong> ${result.confirmation.date}</p>
                                    <p><strong>Time:</strong> ${result.confirmation.time}</p>
                                    <p><strong>Duration:</strong> ${result.confirmation.duration}</p>
                                    <p><strong>Price:</strong> ${result.confirmation.price}</p>
                                </div>
                                <div style="background: #e3f2fd; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                                    <h3 style="color: #1976d2; margin-bottom: 15px;">📹 Video Consultation Link</h3>
                                    <p>At your appointment time, click this link to join:</p>
                                    <p style="text-align: center; margin: 20px 0;">
                                        <a href="${result.confirmation.videoLink}" target="_blank" 
                                           style="background: #1976d2; color: white; padding: 15px 30px; 
                                                  text-decoration: none; border-radius: 8px; display: inline-block; font-weight: 600;">
                                            Join Video Call
                                        </a>
                                    </p>
                                    <p style="word-break: break-all;"><strong>Link:</strong> ${result.confirmation.videoLink}</p>
                                </div>
                                <div style="background: #fff3e0; padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                                    <p><strong>📧 ${result.confirmation.message}</strong></p>
                                    <p style="margin-top: 10px;">Square will send you an email and/or SMS with your appointment details and video link.</p>
                                </div>
                                <div style="text-align: center;">
                                    <button class="btn btn-primary" onclick="window.location.href='/'">Book Another Appointment</button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(result.error || 'Booking failed');
                }
            } catch (error) {
                document.body.innerHTML = `
                    <div class="container" style="margin-top: 50px;">
                        <div class="content">
                            <div class="error-message" style="display: block;">
                                <h3>Booking Error</h3>
                                <p>${error.message}</p>
                                <p>Your payment was processed, but we encountered an issue creating your appointment. Please contact us at (248) 794-7135 or pjawelllness@outlook.com.</p>
                            </div>
                            <button class="btn btn-primary" onclick="window.location.href='/'">Return to Home</button>
                        </div>
                    </div>
                `;
            }
        }

        // STEP NAVIGATION
        function nextStep(step) {
            // Validate current step
            if (!validateStep(currentStep)) {
                return;
            }

            // Show appointment summary on payment step
            if (step === 6) {
                showAppointmentSummary();
            }

            // Hide current step
            document.getElementById(`section${currentStep}`).classList.remove('active');
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${currentStep}`).classList.add('completed');

            // Show next step
            currentStep = step;
            document.getElementById(`section${currentStep}`).classList.add('active');
            document.getElementById(`step${currentStep}`).classList.add('active');

            window.scrollTo(0, 0);
        }

        function previousStep(step) {
            document.getElementById(`section${currentStep}`).classList.remove('active');
            document.getElementById(`step${currentStep}`).classList.remove('active');
            
            currentStep = step;
            document.getElementById(`section${currentStep}`).classList.add('active');
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById(`step${currentStep}`).classList.remove('completed');

            window.scrollTo(0, 0);
        }

        function showAppointmentSummary() {
            const summaryDiv = document.getElementById('appointmentSummary');
            summaryDiv.innerHTML = `
                <p><strong>Patient:</strong> ${document.getElementById('firstName').value} ${document.getElementById('lastName').value}</p>
                <p><strong>Email:</strong> ${document.getElementById('email').value}</p>
                <p><strong>Service:</strong> ${selectedService.name}</p>
                <p><strong>Duration:</strong> ${selectedService.duration} minutes</p>
                <p><strong>Price:</strong> $${selectedService.price}</p>
                <p><strong>Date:</strong> ${document.getElementById('appointmentDate').value}</p>
                <p><strong>Time:</strong> ${selectedTime.time}</p>
            `;
        }

        // VALIDATION
        function validateStep(step) {
            switch(step) {
                case 1:
                    if (!selectedService) {
                        showError('Please select a service');
                        return false;
                    }
                    break;
                case 2:
                    const requiredPersonal = ['firstName', 'lastName', 'email', 'phone', 'dob'];
                    for (let field of requiredPersonal) {
                        if (!document.getElementById(field).value) {
                            showError(`Please fill in ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
                            return false;
                        }
                    }
                    break;
                case 3:
                    if (!document.getElementById('chiefComplaint').value || !document.getElementById('symptomDuration').value) {
                        showError('Please complete all required health information fields');
                        return false;
                    }
                    break;
                case 4:
                    if (!document.getElementById('consentHipaa').checked || !document.getElementById('consentTelehealth').checked) {
                        showError('You must agree to the HIPAA Privacy Notice and Telehealth Consent to continue');
                        return false;
                    }
                    break;
                case 5:
                    if (!selectedTime) {
                        showError('Please select an appointment time');
                        return false;
                    }
                    break;
                case 6:
                    // All validations already done
                    break;
            }
            return true;
        }

        // ERROR HANDLING
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            window.scrollTo(0, 0);
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // PROVIDER PORTAL
        function showProviderPortal() {
            document.getElementById('providerModal').classList.add('active');
        }

        function closeProviderPortal() {
            document.getElementById('providerModal').classList.remove('active');
            document.getElementById('providerLogin').style.display = 'block';
            document.getElementById('providerDashboard').style.display = 'none';
            document.getElementById('providerPassword').value = '';
        }

        async function loginProvider() {
            const password = document.getElementById('providerPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await fetch('/api/provider-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('providerLogin').style.display = 'none';
                    document.getElementById('providerDashboard').style.display = 'block';
                    loadProviderBookings();
                } else {
                    errorDiv.textContent = 'Invalid password';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Login failed. Please try again.';
                errorDiv.style.display = 'block';
            }
        }

        async function loadProviderBookings() {
            try {
                const response = await fetch('/api/provider/bookings');
                const data = await response.json();
                const bookings = data.bookings || [];

                // Calculate stats
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayBookings = bookings.filter(b => {
                    const bookingDate = new Date(b.startAt);
                    bookingDate.setHours(0, 0, 0, 0);
                    return bookingDate.getTime() === today.getTime();
                });

                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 7);
                const weekBookings = bookings.filter(b => {
                    const bookingDate = new Date(b.startAt);
                    return bookingDate >= weekStart && bookingDate < weekEnd;
                });

                document.getElementById('todayCount').textContent = todayBookings.length;
                document.getElementById('weekCount').textContent = weekBookings.length;

                // Display bookings
                const listContainer = document.getElementById('bookingsList');
                if (bookings.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center; color: #666;">No upcoming appointments</p>';
                } else {
                    listContainer.innerHTML = bookings.map(booking => `
                        <div class="booking-card">
                            <h4>${booking.customer.name || 'Unknown Patient'}</h4>
                            <div class="booking-info">
                                <div class="booking-info-item">
                                    <div class="booking-info-label">Date</div>
                                    <div class="booking-info-value">${new Date(booking.startAt).toLocaleDateString()}</div>
                                </div>
                                <div class="booking-info-item">
                                    <div class="booking-info-label">Time</div>
                                    <div class="booking-info-value">${new Date(booking.startAt).toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true})}</div>
                                </div>
                                <div class="booking-info-item">
                                    <div class="booking-info-label">Email</div>
                                    <div class="booking-info-value">${booking.customer.email || 'N/A'}</div>
                                </div>
                                <div class="booking-info-item">
                                    <div class="booking-info-label">Phone</div>
                                    <div class="booking-info-value">${booking.customer.phone || 'N/A'}</div>
                                </div>
                            </div>
                            ${booking.customerNote ? `
                                <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 5px;">
                                    <strong>Chief Complaint:</strong>
                                    <pre style="white-space: pre-wrap; font-family: inherit; margin-top: 10px;">${booking.customerNote}</pre>
                                </div>
                            ` : ''}
                            ${booking.sellerNote ? `
                                <div style="margin-top: 15px; padding: 15px; background: #f5f7ff; border-radius: 5px;">
                                    <strong>Provider Notes:</strong>
                                    <pre style="white-space: pre-wrap; font-family: inherit; margin-top: 10px; font-size: 13px;">${booking.sellerNote}</pre>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                }
            } catch (error) {
                document.getElementById('bookingsList').innerHTML = '<p style="text-align: center; color: #f44336;">Failed to load appointments</p>';
            }
        }
    </script>
</body>
</html>
