<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PJA Wellness - Telehealth Consultations</title>
    <!-- Square Web Payments SDK -->
    <script type="text/javascript" src="https://web.squarecdn.com/v1/square.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }

        .header-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .provider-portal-btn, .patient-portal-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
        }

        .provider-portal-btn:hover, .patient-portal-btn:hover {
            background: white;
            color: #667eea;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            margin-top: 40px; /* Added space between buttons and title on desktop */
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .badge-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .content {
            padding: 40px;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .step.active .step-circle {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .step.completed .step-circle {
            background: #4CAF50;
            color: white;
        }

        .step-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .step.active .step-label {
            color: #667eea;
            font-weight: 600;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .service-card {
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .service-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102,126,234,0.2);
        }

        .service-card.selected {
            border-color: #667eea;
            background: #f5f7ff;
        }

        .service-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .service-price {
            font-size: 2em;
            color: #667eea;
            font-weight: bold;
            margin: 15px 0;
        }

        .service-duration {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .service-description {
            color: #666;
            line-height: 1.6;
        }

        .time-slot-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .time-slot {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .time-slot:hover {
            border-color: #667eea;
            background: #f5f7ff;
        }

        .time-slot.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .checkbox-label:hover {
            border-color: #667eea;
            background: #f5f7ff;
        }

        .checkbox-label input:checked + span {
            color: #667eea;
            font-weight: 600;
        }

        .checkbox-label input {
            margin-right: 8px;
        }

        .consent-box {
            background: #f5f7ff;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .consent-box h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .consent-box p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .consent-checkbox {
            display: flex;
            align-items: flex-start;
            margin-top: 15px;
        }

        .consent-checkbox input {
            margin-right: 10px;
            margin-top: 4px;
        }

        .consent-checkbox label {
            font-size: 14px;
            color: #333;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .summary-box {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-weight: 600;
            color: #666;
        }

        .summary-value {
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            text-align: center;
            padding: 40px;
        }

        .success-icon {
            font-size: 80px;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px 20px 0 0;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: white;
            color: #667eea;
        }

        .modal-body {
            padding: 30px;
        }

        .provider-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .booking-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .booking-card h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .booking-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .booking-info-item {
            display: flex;
            flex-direction: column;
        }

        .booking-info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .booking-info-value {
            color: #333;
        }

        #card-container {
            margin: 20px 0;
        }

        .appointment-detail-box {
            background: #f5f7ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .appointment-detail-box p {
            margin-bottom: 10px;
            color: #333;
        }

        .video-link-box {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .video-link-btn {
            display: inline-block;
            background: #2e7d32;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .video-link-btn:hover {
            background: #1b5e20;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46,125,50,0.3);
        }

        /* MOBILE RESPONSIVE FIX */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 80px 20px 40px 20px; /* Increased top padding for mobile */
            }

            .header-buttons {
                top: 15px;
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                width: calc(100% - 30px);
                justify-content: center;
                flex-wrap: wrap;
            }

            .provider-portal-btn, .patient-portal-btn {
                padding: 8px 16px;
                font-size: 13px;
            }

            .header h1 {
                font-size: 1.8em;
                margin-top: 0; /* Reset margin-top on mobile */
            }

            .header p {
                font-size: 1em;
            }

            .badge-container {
                flex-wrap: wrap;
            }

            .badge {
                font-size: 12px;
                padding: 6px 12px;
            }

            .content {
                padding: 20px;
            }

            .step-indicator {
                overflow-x: auto;
            }

            .step-label {
                font-size: 10px;
            }

            .time-slot-container {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .button-group {
                flex-direction: column;
            }

            .provider-stats {
                grid-template-columns: 1fr;
            }

            .booking-info {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 90px 15px 30px 15px; /* Even more top padding for small mobile */
            }

            .header h1 {
                font-size: 1.5em;
            }

            .service-title {
                font-size: 1.2em;
            }

            .service-price {
                font-size: 1.6em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-buttons">
                <button class="patient-portal-btn" onclick="showPatientPortal()">View My Appointment</button>
                <button class="provider-portal-btn" onclick="showProviderPortal()">Provider Portal</button>
            </div>
            <h1>PJA Wellness</h1>
            <p>Virtual Holistic Health Consultations</p>
            <div class="badge-container">
                <div class="badge">HIPAA Compliant</div>
                <div class="badge">Board Certified</div>
                <div class="badge">HSA/FSA Accepted</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Service</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Personal</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Health</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Consent</div>
                </div>
                <div class="step" data-step="5">
                    <div class="step-circle">5</div>
                    <div class="step-label">Schedule</div>
                </div>
                <div class="step" data-step="6">
                    <div class="step-circle">6</div>
                    <div class="step-label">Payment</div>
                </div>
            </div>

            <!-- Step 1: Service Selection -->
            <div class="form-section active" id="step1">
                <h2>Select Your Service</h2>
                <div id="servicesContainer" class="loading">Loading services...</div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="nextStep(2)" id="step1Next" disabled>Continue</button>
                </div>
            </div>

            <!-- Step 2: Personal Information -->
            <div class="form-section" id="step2">
                <h2>Personal Information</h2>
                <div class="form-group">
                    <label>First Name *</label>
                    <input type="text" id="firstName" required>
                </div>
                <div class="form-group">
                    <label>Last Name *</label>
                    <input type="text" id="lastName" required>
                </div>
                <div class="form-group">
                    <label>Email Address *</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label>Phone Number *</label>
                    <input type="tel" id="phone" required>
                </div>
                <div class="form-group">
                    <label>Date of Birth *</label>
                    <input type="date" id="dob" required>
                </div>
                <div class="form-group">
                    <label>Emergency Contact Name</label>
                    <input type="text" id="emergencyName">
                </div>
                <div class="form-group">
                    <label>Emergency Contact Phone</label>
                    <input type="tel" id="emergencyPhone">
                </div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep(1)">Back</button>
                    <button class="btn btn-primary" onclick="nextStep(3)">Continue</button>
                </div>
            </div>

            <!-- Step 3: Health Information -->
            <div class="form-section" id="step3">
                <h2>Health Information</h2>
                <div class="form-group">
                    <label>What is your main reason for today's visit? (Chief Complaint) *</label>
                    <textarea id="chiefComplaint" required></textarea>
                </div>
                <div class="form-group">
                    <label>How long have you been experiencing these symptoms? *</label>
                    <select id="symptomDuration" required>
                        <option value="">Select duration...</option>
                        <option value="Less than 24 hours">Less than 24 hours</option>
                        <option value="1-3 days">1-3 days</option>
                        <option value="4-7 days">4-7 days</option>
                        <option value="1-2 weeks">1-2 weeks</option>
                        <option value="2-4 weeks">2-4 weeks</option>
                        <option value="More than 1 month">More than 1 month</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Select all current symptoms:</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label"><input type="checkbox" value="Fever"><span>Fever</span></label>
                        <label class="checkbox-label"><input type="checkbox" value="Cough"><span>Cough</span></label>
                        <label class="checkbox-label"><input type="checkbox" value="Fatigue"><span>Fatigue</span></label>
                        <label class="checkbox-label"><input type="checkbox" value="Headache"><span>Headache</span></label>
                        <label class="checkbox-label"><input type="checkbox" value="Nausea"><span>Nausea</span></label>
                        <label class="checkbox-label"><input type="checkbox" value="Pain"><span>Pain</span></label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Current Medications (including supplements)</label>
                    <textarea id="medications" placeholder="List all medications and dosages..."></textarea>
                </div>
                <div class="form-group">
                    <label>Known Allergies (medications, food, environmental)</label>
                    <textarea id="allergies" placeholder="List all known allergies..."></textarea>
                </div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep(2)">Back</button>
                    <button class="btn btn-primary" onclick="nextStep(4)">Continue</button>
                </div>
            </div>

            <!-- Step 4: Consents -->
            <div class="form-section" id="step4">
                <h2>Informed Consent</h2>
                
                <!-- HIPAA Privacy Notice -->
                <div class="consent-box">
                    <h3>HIPAA Privacy Notice</h3>
                    <p>PJA Wellness Management LLC is committed to protecting your health information. This notice describes how medical information about you may be used and disclosed and how you can access this information.</p>
                    <p><strong>Your Rights:</strong> You have the right to request restrictions on certain uses and disclosures of your health information, to receive confidential communications, to inspect and copy your health information, to amend your health information, and to receive an accounting of disclosures.</p>
                    <p><strong>Our Responsibilities:</strong> We are required by law to maintain the privacy of your health information, provide you with this notice, and abide by the terms currently in effect. We will not use or disclose your health information without your authorization, except as described in this notice.</p>
                    <p><strong>Uses and Disclosures:</strong> We may use and disclose your health information for treatment, payment, and healthcare operations. For example, we may share your information with other healthcare providers treating you, with insurance companies for billing purposes, or for quality improvement activities.</p>
                    <div class="consent-checkbox">
                        <input type="checkbox" id="hipaaConsent" required>
                        <label for="hipaaConsent">I acknowledge that I have received and reviewed the HIPAA Privacy Notice and understand my rights and PJA Wellness's responsibilities regarding my protected health information. *</label>
                    </div>
                </div>

                <!-- Telehealth Informed Consent -->
                <div class="consent-box">
                    <h3>Telehealth Informed Consent</h3>
                    <p><strong>Nature of Telehealth Services:</strong> Telehealth involves the use of electronic communications to enable health care providers at different locations to share individual patient medical information for the purpose of improving patient care. This may include live two-way audio and video, recorded health information, or other electronic means.</p>
                    <p><strong>Benefits:</strong> Improved access to care by enabling you to remain at home or at a remote location, more efficient medical evaluation and management, and reduced travel time and costs.</p>
                    <p><strong>Potential Risks:</strong> While telehealth has been shown to be effective, there are potential risks including but not limited to: delays in medical evaluation and treatment could occur due to technical difficulties, security protocols could fail causing a breach of privacy, or lack of access to complete medical records may result in adverse drug interactions or allergic reactions.</p>
                    <p><strong>Privacy and Security:</strong> We use Doxy.me, a HIPAA-compliant video platform, to conduct secure video consultations. Your session is encrypted and protected. However, no data transmission over the internet is 100% secure.</p>
                    <p><strong>Your Responsibilities:</strong> You are responsible for providing accurate health information, being in a private location for your consultation, having a reliable internet connection, and following up with in-person care if recommended.</p>
                    <p><strong>Right to Refuse:</strong> You have the right to withhold or withdraw consent to the use of telehealth at any time. This will not affect your right to future care or treatment.</p>
                    <div class="consent-checkbox">
                        <input type="checkbox" id="telehealthConsent" required>
                        <label for="telehealthConsent">I consent to receiving healthcare services via telehealth. I understand the potential risks and benefits, and I have had the opportunity to ask questions. I understand that I may withdraw this consent at any time. *</label>
                    </div>
                </div>

                <!-- Recording Consent -->
                <div class="consent-box">
                    <h3>Session Recording (Optional)</h3>
                    <p>For quality assurance and training purposes, we may record telehealth sessions. You may decline this without affecting your care.</p>
                    <div class="consent-checkbox">
                        <input type="checkbox" id="recordingConsent">
                        <label for="recordingConsent">I consent to recording of my telehealth session for quality assurance and training purposes.</label>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep(3)">Back</button>
                    <button class="btn btn-primary" onclick="nextStep(5)">Continue</button>
                </div>
            </div>

            <!-- Step 5: Schedule -->
            <div class="form-section" id="step5">
                <h2>Schedule Your Appointment</h2>
                <div class="form-group">
                    <label>Select Date *</label>
                    <input type="date" id="appointmentDate" min="">
                </div>
                <div id="timeSlotsContainer"></div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep(4)">Back</button>
                    <button class="btn btn-primary" onclick="nextStep(6)" id="step5Next" disabled>Continue to Payment</button>
                </div>
            </div>

            <!-- Step 6: Payment & Summary -->
            <div class="form-section" id="step6">
                <h2>Review & Payment</h2>
                <div id="summaryContainer"></div>
                <div id="card-container"></div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep(5)">Back</button>
                    <button class="btn btn-primary" onclick="processPayment()" id="payButton">Complete Booking</button>
                </div>
            </div>

            <!-- Success -->
            <div class="form-section" id="success">
                <div class="success">
                    <div class="success-icon">✓</div>
                    <h2>Booking Confirmed!</h2>
                    <div id="confirmationDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Portal Modal -->
    <div class="modal" id="patientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Patient Portal</h2>
                <button class="modal-close" onclick="closePatientPortal()">×</button>
            </div>
            <div class="modal-body">
                <!-- Login Form -->
                <div id="patientLogin">
                    <p style="margin-bottom: 20px;">Enter your 6-digit access code and email to view your appointment details.</p>
                    <div class="form-group">
                        <label>Access Code</label>
                        <input type="text" id="patientAccessCode" maxlength="6" placeholder="6-digit code">
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="patientEmail" placeholder="your@email.com">
                    </div>
                    <div id="patientLoginError" class="error" style="display: none;"></div>
                    <button class="btn btn-primary" onclick="loginPatient()" style="width: 100%;">View Appointment</button>
                </div>
                <!-- Appointment Display -->
                <div id="patientAppointment" style="display: none;">
                    <div id="appointmentDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Provider Portal Modal -->
    <div class="modal" id="providerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Provider Portal</h2>
                <button class="modal-close" onclick="closeProviderPortal()">×</button>
            </div>
            <div class="modal-body">
                <!-- Login -->
                <div id="providerLogin">
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="providerPassword">
                    </div>
                    <div id="loginError" class="error" style="display: none;"></div>
                    <button class="btn btn-primary" onclick="loginProvider()" style="width: 100%;">Login</button>
                </div>
                <!-- Dashboard -->
                <div id="providerDashboard" style="display: none;">
                    <div class="provider-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="todayCount">0</div>
                            <div class="stat-label">Today's Appointments</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="weekCount">0</div>
                            <div class="stat-label">This Week</div>
                        </div>
                    </div>
                    <h3 style="margin-bottom: 20px;">Upcoming Appointments</h3>
                    <div id="bookingsList"></div>
                    <p style="text-align: center; margin-top: 20px;">
                        <a href="https://doxy.me/PatrickPJAwellness/provider" target="_blank" class="video-link-btn">Open Provider Video Portal</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let currentStep = 1;
        let bookingData = {
            service: null,
            personal: {},
            health: {},
            consents: {},
            schedule: {}
        };
        let squarePayments;
        let card;
        let squareConfig = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('appointmentDate').min = today;
            
            // Load Square config
            try {
                const response = await fetch('/api/square-config');
                squareConfig = await response.json();
                console.log('Square config loaded:', squareConfig);
            } catch (error) {
                console.error('Failed to load Square config:', error);
            }
            
            loadServices();
        });

        // Load Services
        async function loadServices() {
            try {
                const response = await fetch('/api/services');
                const data = await response.json();
                
                const container = document.getElementById('servicesContainer');
                
                if (data.services.length === 0) {
                    container.innerHTML = '<div class="error">No services available at this time.</div>';
                    return;
                }
                
                container.innerHTML = data.services.map(service => `
                    <div class="service-card" onclick="selectService('${service.id}')">
                        <div class="service-title">${service.name}</div>
                        <div class="service-price">$${service.price}</div>
                        <div class="service-duration">⏱️ ${service.duration} minutes</div>
                        <div class="service-description">${service.description}</div>
                    </div>
                `).join('');
                
            } catch (error) {
                document.getElementById('servicesContainer').innerHTML = 
                    '<div class="error">Failed to load services. Please refresh the page.</div>';
            }
        }

        // Select Service
        async function selectService(serviceId) {
            const response = await fetch('/api/services');
            const data = await response.json();
            bookingData.service = data.services.find(s => s.id === serviceId);
            
            document.querySelectorAll('.service-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.service-card').classList.add('selected');
            document.getElementById('step1Next').disabled = false;
        }

        // Navigation
        function nextStep(step) {
            // Validate current step
            if (step === 2 && !bookingData.service) {
                alert('Please select a service');
                return;
            }
            
            if (step === 3) {
                const personal = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    dob: document.getElementById('dob').value,
                    emergencyName: document.getElementById('emergencyName').value,
                    emergencyPhone: document.getElementById('emergencyPhone').value
                };
                
                if (!personal.firstName || !personal.lastName || !personal.email || !personal.phone || !personal.dob) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                bookingData.personal = personal;
            }
            
            if (step === 4) {
                const symptoms = Array.from(document.querySelectorAll('.checkbox-group input:checked')).map(cb => cb.value);
                const health = {
                    chiefComplaint: document.getElementById('chiefComplaint').value,
                    symptomDuration: document.getElementById('symptomDuration').value,
                    symptoms: symptoms,
                    medications: document.getElementById('medications').value,
                    allergies: document.getElementById('allergies').value
                };
                
                if (!health.chiefComplaint || !health.symptomDuration) {
                    alert('Please fill in all required health information');
                    return;
                }
                
                bookingData.health = health;
            }
            
            if (step === 5) {
                const consents = {
                    hipaa: document.getElementById('hipaaConsent').checked,
                    telehealth: document.getElementById('telehealthConsent').checked,
                    recording: document.getElementById('recordingConsent').checked
                };
                
                if (!consents.hipaa || !consents.telehealth) {
                    alert('You must acknowledge the HIPAA Privacy Notice and consent to telehealth services to continue');
                    return;
                }
                
                bookingData.consents = consents;
            }
            
            if (step === 6) {
                if (!bookingData.schedule.selectedTime) {
                    alert('Please select a time slot');
                    return;
                }
                showSummary();
                initializeSquarePayments();
            }
            
            // Update UI
            document.querySelectorAll('.form-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            
            document.querySelectorAll('.step').forEach(stepEl => stepEl.classList.remove('active'));
            document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
            
            // Mark completed steps
            for (let i = 1; i < step; i++) {
                document.querySelector(`.step[data-step="${i}"]`).classList.add('completed');
            }
            
            currentStep = step;
            window.scrollTo(0, 0);
        }

        function previousStep(step) {
            nextStep(step);
        }

        // Load Availability
        document.getElementById('appointmentDate').addEventListener('change', async (e) => {
            const date = e.target.value;
            if (!date) return;
            
            const container = document.getElementById('timeSlotsContainer');
            container.innerHTML = '<div class="loading">Loading available times...</div>';
            
            try {
                const response = await fetch('/api/availability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        serviceVariationId: bookingData.service.variationId,
                        date: date
                    })
                });
                
                const data = await response.json();
                
                if (data.availabilities.length === 0) {
                    container.innerHTML = '<div class="error">No available times for this date. Please select another date.</div>';
                    return;
                }
                
                container.innerHTML = `
                    <h3 style="margin: 20px 0;">Available Times</h3>
                    <div class="time-slot-container">
                        ${data.availabilities.map(slot => `
                            <div class="time-slot" onclick="selectTimeSlot('${slot.startAt}', '${slot.time}')">
                                ${slot.time}
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                container.innerHTML = '<div class="error">Failed to load available times. Please try again.</div>';
            }
        });

        // Select Time Slot
        function selectTimeSlot(startAt, time) {
            bookingData.schedule = {
                date: document.getElementById('appointmentDate').value,
                selectedTime: { startAt, time }
            };
            
            document.querySelectorAll('.time-slot').forEach(slot => slot.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('step5Next').disabled = false;
        }

        // Show Summary
        function showSummary() {
            const summary = `
                <div class="summary-box">
                    <h3>Booking Summary</h3>
                    <div class="summary-item">
                        <span class="summary-label">Service:</span>
                        <span class="summary-value">${bookingData.service.name}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Date:</span>
                        <span class="summary-value">${new Date(bookingData.schedule.date).toLocaleDateString()}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Time:</span>
                        <span class="summary-value">${bookingData.schedule.selectedTime.time}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Duration:</span>
                        <span class="summary-value">${bookingData.service.duration} minutes</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Patient:</span>
                        <span class="summary-value">${bookingData.personal.firstName} ${bookingData.personal.lastName}</span>
                    </div>
                    <div class="summary-item" style="font-size: 1.2em; font-weight: bold; color: #667eea;">
                        <span class="summary-label">Total:</span>
                        <span class="summary-value">$${bookingData.service.price}</span>
                    </div>
                </div>
            `;
            document.getElementById('summaryContainer').innerHTML = summary;
        }

        // Initialize Square Payments
        async function initializeSquarePayments() {
            if (!window.Square) {
                console.error('Square.js failed to load');
                return;
            }
            
            try {
                squarePayments = window.Square.payments(squareConfig.applicationId, squareConfig.locationId);
                card = await squarePayments.card();
                await card.attach('#card-container');
            } catch (error) {
                console.error('Failed to initialize Square Payments:', error);
            }
        }

        // Process Payment
        async function processPayment() {
            const payButton = document.getElementById('payButton');
            payButton.disabled = true;
            payButton.textContent = 'Processing...';
            
            try {
                const result = await card.tokenize();
                if (result.status === 'OK') {
                    await createBooking(result.token);
                } else {
                    alert('Payment failed: ' + result.errors[0].message);
                    payButton.disabled = false;
                    payButton.textContent = 'Complete Booking';
                }
            } catch (error) {
                alert('Payment error: ' + error.message);
                payButton.disabled = false;
                payButton.textContent = 'Complete Booking';
            }
        }

        // Create Booking
        async function createBooking(paymentToken) {
            try {
                const response = await fetch('/api/create-booking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        service: bookingData.service,
                        personal: bookingData.personal,
                        health: bookingData.health,
                        consents: bookingData.consents,
                        selectedTime: bookingData.schedule.selectedTime,
                        paymentToken: paymentToken
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result);
                } else {
                    alert('Booking failed: ' + (result.error || 'Unknown error'));
                    document.getElementById('payButton').disabled = false;
                    document.getElementById('payButton').textContent = 'Complete Booking';
                }
            } catch (error) {
                alert('Booking error: ' + error.message);
                document.getElementById('payButton').disabled = false;
                document.getElementById('payButton').textContent = 'Complete Booking';
            }
        }

        // Show Success
        function showSuccess(result) {
            document.querySelectorAll('.form-section').forEach(section => section.classList.remove('active'));
            document.getElementById('success').classList.add('active');
            
            document.getElementById('confirmationDetails').innerHTML = `
                <div class="summary-box">
                    <h3>🎉 Your Appointment is Confirmed!</h3>
                    <div class="summary-item">
                        <span class="summary-label">Access Code:</span>
                        <span class="summary-value" style="font-size: 1.5em; color: #667eea; font-weight: bold;">${result.accessCode}</span>
                    </div>
                    <p style="color: #666; margin: 20px 0;">Save this code! You'll need it to view your appointment details.</p>
                    
                    <div class="summary-item">
                        <span class="summary-label">Service:</span>
                        <span class="summary-value">${result.confirmation.service}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Date:</span>
                        <span class="summary-value">${result.confirmation.date}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Time:</span>
                        <span class="summary-value">${result.confirmation.time}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Duration:</span>
                        <span class="summary-value">${result.confirmation.duration}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Amount Paid:</span>
                        <span class="summary-value">${result.confirmation.price}</span>
                    </div>
                </div>
                
                <div class="video-link-box">
                    <h3 style="color: #2e7d32;">📹 Video Consultation</h3>
                    <p>At your appointment time, join your video call:</p>
                    <a href="${result.confirmation.videoLink}" target="_blank" class="video-link-btn" style="margin-top: 15px;">
                        Join Video Call
                    </a>
                </div>
                
                <p style="text-align: center; color: #666; margin-top: 20px;">
                    ${result.confirmation.message}
                </p>
            `;
            
            // Reset form after 5 seconds
            setTimeout(() => {
                location.reload();
            }, 5000);
        }

        // PATIENT PORTAL
        function showPatientPortal() {
            document.getElementById('patientModal').classList.add('active');
        }

        function closePatientPortal() {
            document.getElementById('patientModal').classList.remove('active');
            document.getElementById('patientLogin').style.display = 'block';
            document.getElementById('patientAppointment').style.display = 'none';
            document.getElementById('patientAccessCode').value = '';
            document.getElementById('patientEmail').value = '';
        }

        async function loginPatient() {
            const accessCode = document.getElementById('patientAccessCode').value;
            const email = document.getElementById('patientEmail').value;
            const errorDiv = document.getElementById('patientLoginError');

            if (!accessCode || accessCode.length !== 6) {
                errorDiv.textContent = 'Please enter your 6-digit access code';
                errorDiv.style.display = 'block';
                return;
            }

            if (!email) {
                errorDiv.textContent = 'Please enter your email address';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/patient-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accessCode: accessCode,
                        email: email
                    })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('patientLogin').style.display = 'none';
                    document.getElementById('patientAppointment').style.display = 'block';
                    displayAppointment(result.appointment);
                } else {
                    errorDiv.textContent = result.error || 'Invalid access code or email address';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Failed to verify appointment. Please try again.';
                errorDiv.style.display = 'block';
            }
        }

        function displayAppointment(appointment) {
            const detailsDiv = document.getElementById('appointmentDetails');
            detailsDiv.innerHTML = `
                <div class="appointment-detail-box">
                    <h3 style="margin-bottom: 20px;">📅 Appointment Information</h3>
                    <p><strong>Patient:</strong> ${appointment.patient.name}</p>
                    <p><strong>Email:</strong> ${appointment.patient.email}</p>
                    <p><strong>Phone:</strong> ${appointment.patient.phone}</p>
                    <p><strong>Date:</strong> ${appointment.date}</p>
                    <p><strong>Time:</strong> ${appointment.time}</p>
                    <p><strong>Duration:</strong> ${appointment.duration} minutes</p>
                    <p><strong>Status:</strong> <span style="color: #4CAF50; font-weight: 600;">${appointment.status || 'CONFIRMED'}</span></p>
                </div>

                <div class="video-link-box">
                    <h3 style="color: #2e7d32; margin-bottom: 15px;">📹 Video Consultation</h3>
                    <p style="margin-bottom: 15px;">At your appointment time, join your video call:</p>
                    <a href="${appointment.videoLink}" target="_blank" class="video-link-btn">
                        Join Video Call
                    </a>
                    <p style="margin-top: 15px; font-size: 14px; color: #666;">
                        Click the button above to access your secure video consultation. No software download required!
                    </p>
                </div>

                ${appointment.customerNote ? `
                    <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-top: 20px;">
                        <h4 style="margin-bottom: 10px;">Your Notes:</h4>
                        <pre style="white-space: pre-wrap; font-family: inherit; font-size: 14px; color: #666;">${appointment.customerNote}</pre>
                    </div>
                ` : ''}
            `;
        }

        // PROVIDER PORTAL
        function showProviderPortal() {
            document.getElementById('providerModal').classList.add('active');
        }

        function closeProviderPortal() {
            document.getElementById('providerModal').classList.remove('active');
            document.getElementById('providerLogin').style.display = 'block';
            document.getElementById('providerDashboard').style.display = 'none';
            document.getElementById('providerPassword').value = '';
        }

        async function loginProvider() {
            const password = document.getElementById('providerPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await fetch('/api/provider-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('providerLogin').style.display = 'none';
                    document.getElementById('providerDashboard').style.display = 'block';
                    loadProviderBookings();
                } else {
                    errorDiv.textContent = 'Invalid password';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Login failed. Please try again.';
                errorDiv.style.display = 'block';
            }
        }

        async function loadProviderBookings() {
            try {
                const response = await fetch('/api/provider/bookings');
                const data = await response.json();
                const bookings = data.bookings || [];

                // Calculate stats
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayBookings = bookings.filter(b => {
                    const bookingDate = new Date(b.startAt);
                    bookingDate.setHours(0, 0, 0, 0);
                    return bookingDate.getTime() === today.getTime();
                });

                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 7);
                const weekBookings = bookings.filter(b => {
                    const bookingDate = new Date(b.startAt);
                    return bookingDate >= weekStart && bookingDate < weekEnd;
                });

                document.getElementById('todayCount').textContent = todayBookings.length;
                document.getElementById('weekCount').textContent = weekBookings.length;

                // Display bookings
                const listContainer = document.getElementById('bookingsList');
                if (bookings.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center; color: #666;">No upcoming appointments</p>';
                } else {
                    listContainer.innerHTML = bookings.map(booking => `
                        <div class="booking-card">
                            <h4>${booking.customer.name || 'Unknown Patient'}</h4>
                            <div class="booking-info">
                                <div class="booking-info-item">
                                    <div class="booking-info-label">Date</div>
                                    <div class="booking-info-value">${new Date(booking.startAt).toLocaleDateString()}</div>
                                </div>
                                <div class="booking-info-item">
                                    <div class="booking-info-label">Time</div>
                                    <div class="booking-info-value">${new Date(booking.startAt).toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true})}</div>
                                </div>
                                <div class="booking-info-item">
                                    <div class="booking-info-label">Email</div>
                                    <div class="booking-info-value">${booking.customer.email || 'N/A'}</div>
                                </div>
                                <div class="booking-info-item">
                                    <div class="booking-info-label">Phone</div>
                                    <div class="booking-info-value">${booking.customer.phone || 'N/A'}</div>
                                </div>
                            </div>
                            ${booking.customerNote ? `
                                <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 5px;">
                                    <strong>Chief Complaint:</strong>
                                    <pre style="white-space: pre-wrap; font-family: inherit; margin-top: 10px;">${booking.customerNote}</pre>
                                </div>
                            ` : ''}
                            ${booking.sellerNote ? `
                                <div style="margin-top: 15px; padding: 15px; background: #f5f7ff; border-radius: 5px;">
                                    <strong>Provider Notes:</strong>
                                    <pre style="white-space: pre-wrap; font-family: inherit; margin-top: 10px; font-size: 13px;">${booking.sellerNote}</pre>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                }
            } catch (error) {
                document.getElementById('bookingsList').innerHTML = '<p style="text-align: center; color: #f44336;">Failed to load appointments</p>';
            }
        }
    </script>
</body>
</html>
